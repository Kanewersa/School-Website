<%= stylesheet_link_tag 'custom/bootstrap-datepicker3.standalone.min' %>
<style>
  .hidden {
    display: none;
  }
</style>
<div class="modal fade" id="createEventModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h3 class="modal-title">Dodawanie nowego wydarzenia</h3>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <%= form_for :event, :remote => true, authenticity_token: true, url: events_path do |f| %>
        <!-- Modal body -->
        <div class="modal-body">
          <p>
            <%= f.label "Nazwa wydarzenia:", :class => "h5" %><br>
            <%= f.text_field :title, id: 'source', :class => "form-control" %>
          </p>
          <p>
            <%= f.label "Adres:", :class => "h5" %>
            <br>
            <%= f.text_field :slug, id: 'result', disabled: true, :class => "form-control" %>
          </p>
          <p>
            <%= f.label "Wybierz kategorię:", :class => "h5" %><br>
            <%= f.select :category_id, Category.all.map { |t| [t.title, t.id] }, {}, {class: "form-control"} %>
          </p>
          <p>
            <%= f.label "Priorytet:", :id => "important", :class => "h5" %>
            <%= f.check_box :important %>
            <%= f.label "Ogłoszenie:", :class => "h5" %>
            <%= f.check_box :announcement %>
          </p>
            <div class="container hidden" id="date-toggle">
              <%= f.label "Ważny do:", :id => "valid_date", :class => "h6" %>
              <%= f.text_field :valid_date, :data => {:provide => "datepicker", :date_format => "yyyy-mm-dd"}, :class => "form-control w-25" %>
              <br>
            </div>
          <p>
            <%= f.label "Obraz:", :class => "h5" %>
          </p>
          <div class="input-group">
            <span class="input-group-btn">
              <span id="browse" class="btn btn-small btn-warning">Przeglądaj</span>
              <%= f.file_field :image, id: "image-name-preview", style: "display: none;" %>
            </span>
            <span class="form-control"></span>
          </div>
          <p>
            <br>
            <%= f.label "Zawartość:", :class => "h5" %><br>
            <%= f.rich_text_area :body, :spellcheck => false %>
          </p>
          <p>
            <%= f.label "Galeria:", :class => "h5" %><br>
          </p>
          <div class="alert alert-danger">
            <strong>Niedostępne</strong>
          </div>
          <br>
        </div>
        <!-- Modal footer -->
        <div class="modal-footer">
          <%= f.submit "Dodaj wydarzenie", :class => "btn btn-warning" %>
          <%= f.submit "Podgląd", :class => "btn btn-success" %>
          <button type="button" class="btn btn-danger" data-dismiss="modal">Anuluj</button>
        </div>
      <% end %>
    </div>
  </div>
</div>
<div class="modal fade" id="testmodal">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">

      <!-- Modal body -->
      <div id="event-preview" class="modal-body">
        XD
      </div>

    </div>
  </div>
</div>
<script>
    $('form').on('ajax:success', function(event, data, status, xhr) {
        console.log(data);
        $('#testmodal').modal('show');
        var source = $("#image-name-preview");
        if(source[0].files.length > 0)
        {
            var getImagePath = URL.createObjectURL(source[0].files[0]);
            $('#jumbo').css('background', 'url(' + getImagePath + ')');
        }
    });
    $('form').on('ajax:error', function(event, data, status, xhr) {
        //location.reload();
        console.log(data);
    });
</script>
<script>
    //Show/Hide datepicker
    const $announcement = document.querySelector('#event_announcement');
    const $important = document.querySelector('#event_important');
    const $date_toggle = document.querySelector('#date-toggle');

    //Toggle important checkbox
    const setBox = function (e) {
      if(e.target.checked)
      {
        $important.checked = true;
        $important.disabled = true;
      } else
        $important.disabled = false;

      toggleDatePicker();
    };

    //Toggle datepicker
    const toggleDatePicker = function (e) {
      if($important.checked) $date_toggle.classList.remove("hidden");
      else $date_toggle.classList.add("hidden");
    };
    //$('.datepicker').datepicker();

    //Sub-tabs address input
    const $source = document.querySelector('#source');
    const $result = document.querySelector('#result');

    String.prototype.escapeDiacritics = function () {
        return this.replace(/ą/g, 'a').replace(/Ą/g, 'A')
            .replace(/ć/g, 'c').replace(/Ć/g, 'C')
            .replace(/ę/g, 'e').replace(/Ę/g, 'E')
            .replace(/ł/g, 'l').replace(/Ł/g, 'L')
            .replace(/ń/g, 'n').replace(/Ń/g, 'N')
            .replace(/ó/g, 'o').replace(/Ó/g, 'O')
            .replace(/ś/g, 's').replace(/Ś/g, 'S')
            .replace(/ż/g, 'z').replace(/Ż/g, 'Z')
            .replace(/ź/g, 'z').replace(/Ź/g, 'Z');
    };

    const typeHandler = function (e) {
        var text = e.target.value;
        $result.value = text.replace(/\s+/g, '-').toLowerCase().escapeDiacritics();
    };
    $source.addEventListener('input', typeHandler);
    $announcement.addEventListener('input', setBox);
    $important.addEventListener('input', toggleDatePicker);

    $(document).ready(function () {

        $('#openBtn').click(function () {
            $('#myModal').modal({
                show: true
            })
        });

        $(document).on({
            'show.bs.modal': function () {
                var zIndex = 1040 + (10 * $('.modal:visible').length);
                $(this).css('z-index', zIndex);
                setTimeout(function() {
                    $('.modal-backdrop').not('.modal-stack').css('z-index', zIndex - 1).addClass('modal-stack');
                }, 0);
            },
            'hidden.bs.modal': function() {
                if ($('.modal:visible').length > 0) {
                    // restore the modal-open class to the body element, so that scrolling works
                    // properly after de-stacking a modal.
                    setTimeout(function() {
                        $(document.body).addClass('modal-open');
                    }, 0);
                }
            }
        }, '.modal');
    });
</script>
<%= javascript_pack_tag "datepicker.js" %>